# DM Toolkit Schema & API Gap Analysis (Wave 2, Task 2)

## Summary
- Compared `dmtoolkit.md` / `dmtoolkit.yaml` requirements against the canonical schema (`database/schema.sql`), live database introspection, and current API handlers (`server/database-server.js`) plus published contracts (`API_DOCUMENTATION.md`).
- Identified schema objects that are missing or misaligned, along with API/documentation gaps that will block DM Toolkit delivery.
- The items below are ordered in the sequence they should be addressed; each entry calls out whether the change belongs in `database/schema.sql`, the API layer, or both.

## Schema Discrepancies

| # | Area | Spec Reference | Current State | Required Remediation | Target Artifacts |
|---|------|----------------|---------------|----------------------|------------------|
| 1 | Campaign unique name | `dmtoolkit.md` §4.1; DDL sketch | Neither the canonical schema (`database/schema.sql:260-282`) nor the live DB (`\d+ public.campaigns`) enforce `(dm_user_id, lower(name))` uniqueness. | Add `CREATE UNIQUE INDEX uq_campaign_name_per_dm ON public.campaigns (dm_user_id, lower(name));` to `database/schema.sql` and apply to the live database. Update error handling paths to surface 409s when the constraint is hit. | `database/schema.sql`, `server/database-server.js`, `API_DOCUMENTATION.md` |
| 2 | Spawn column naming + defaults | `dmtoolkit.md` §4.2, DDL sketch | `campaign_spawns` is defined with `description TEXT`, `is_default BOOLEAN DEFAULT false`, and no default for `name` (`database/schema.sql:367-378`; live DB matches). Spec requires `note TEXT`, `is_default DEFAULT true`, and default spawn name. | Rename `description` → `note`, set `name TEXT NOT NULL DEFAULT 'Default Spawn'`, and default `is_default` to `true`. Ensure updates cascade through API formatting and docs. | `database/schema.sql`, `server/database-server.js`, `API_DOCUMENTATION.md`, client typings |
| 3 | Spawn SRID enforcement drift | `dmtoolkit.md` §4.2 | Canonical schema already defines `geometry(Point, 0)` (`database/schema.sql:372`), but the live column is `geometry(Point)` (`\d+ public.campaign_spawns`). | Run ALTER to enforce SRID 0 (e.g., rebuild column via `USING ST_SetSRID(world_position, 0)` plus a check constraint if needed) when refreshing the schema on an empty DB. Confirm API upserts continue to call `ST_SetSRID(..., 0)`. | `database/schema.sql`, live DDL application |
| 4 | Campaign objectives table | `dmtoolkit.md` §4.3 / DDL sketch | Absent from both `database/schema.sql` and the live database (`to_regclass('public.campaign_objectives')` returns null). | Create `campaign_objectives` table with hierarchy (`parent_id`), location union fields, markdown columns, SRID-0 geometry, indexes per spec. | `database/schema.sql` |
| 5 | Sessions sidebar fields | `dmtoolkit.md` §4.4 | `sessions` table (schema file lines 497-519; live DB) lacks `dm_focus` and `dm_context_md`. | Add nullable `dm_focus TEXT` and `dm_context_md TEXT` columns to `database/schema.sql` and ensure the canonical schema keeps them up to date. | `database/schema.sql` |

## API & Service Gaps

| # | Endpoint Group | Spec Reference | Current Implementation | Required Remediation | Target Artifacts |
|---|----------------|----------------|------------------------|----------------------|------------------|
| A | Campaign create/update | `dmtoolkit.md` §5 (Campaigns) | `POST /api/campaigns` (`server/database-server.js:2140-2190`) requires `dmUserId` from the request body, applies hardcoded defaults (`system`, `setting`, `maxPlayers`), and does not catch unique-name conflicts. `PUT /api/campaigns/:id` mirrors the same patterns. API docs omit the DM Toolkit validations. | Use `req.user.id` for `dm_user_id`, enforce `max_players` ∈ [1,20] and ordered `level_range`, catch unique-index violations and emit 409 JSON, and remove placeholder defaults unless explicitly provided. Document the contract update. | `server/database-server.js`, validation helpers, `API_DOCUMENTATION.md`, `dmtoolkit_tasks_2.md` follow-ups |
| B | Spawn API contract | `dmtoolkit.md` §5 (Spawn) | Existing routes use plural resource (`GET/POST/PUT/DELETE /api/campaigns/:campaignId/spawns`), expect ad-hoc payloads with `{name, description, worldPosition}`, and allow multi-record updates. Spec requires idempotent upsert via `PUT /api/campaigns/:campaignId/spawn` returning `{ note, geometry }`. | Collapse create/update into a single PUT upsert, rename payload fields to align with `note`, ensure SRID-0 enforcement, and update docs/WebSocket payloads. Keep list endpoint only if needed for backward compatibility with explicit documentation. | `server/database-server.js`, `API_DOCUMENTATION.md`, WebSocket schema notes |
| C | Objective CRUD + validation | `dmtoolkit.md` §5 (Objectives) | No endpoints or validation helpers exist (`rg 'objectives' server/database-server.js` returns none). | Implement full CRUD routes, shared validation utilities enforcing single-location rule, and persistence via the new table. Document request/response shapes. | `server/...` (new module), `tests/server/...`, `API_DOCUMENTATION.md` |
| D | Objective LLM assists | `dmtoolkit.md` §5 (Objective LLM Assist) | Absent. | Add assist endpoints hooking into `server/llm`, logging, and documentation. | Backend routes/services, tests, `API_DOCUMENTATION.md` |
| E | DM Sidebar endpoints | `dmtoolkit.md` §5 (DM Sidebar) | Focus/context, unplanned encounter, sentiment, and teleport routes either do not exist or remain in legacy form without DM Toolkit fields (reviewed sections 2326-2670 for movement/spawns; no focus/context endpoints present). **Update (Task 13 – 2025-09-24): Implemented in `server/database-server.js` with integration coverage (`tests/server/dm-sidebar.integration.test.js`) and documented in `API_DOCUMENTATION.md` §DM Sidebar. Gap closed.** | Implement/realign endpoints, transactions, and telemetry per spec; document final contract. | `server/database-server.js`, support modules, `API_DOCUMENTATION.md` |
| F | Documentation parity | `dmtoolkit_tasks_2.md` recurring requirement | `API_DOCUMENTATION.md` currently lacks DM Toolkit sections (no spawn/objective/sidebar entries). **Update (Tasks 9–13): Spawn, objective, assist, and DM Sidebar sections have been added; maintain parity as new slices land.** | After endpoints ship, add detailed sections covering request parameters, payloads, and SRID notes. Track "no change" confirmations per slice. | `API_DOCUMENTATION.md` |

## Ordered Remediation Plan
1. Update `database/schema.sql` (Task 3) to add the campaign unique index, rename/adjust spawn columns/defaults, create `campaign_objectives`, and extend `sessions` with DM Sidebar fields. Regenerate schema against an empty database to ensure SRID-0 compliance.
2. Harden campaign endpoints (Task 8) so they honour the new constraint and validation requirements, with documentation updates.
3. Realign spawn API (Task 9), followed by introduction of objective validation utilities (Task 10) and CRUD endpoints (Task 11).
4. Layer in Objective LLM assist routes (Task 12), DM Sidebar suite (Task 13), and realtime/logging/documentation updates as outlined in later tasks.

## Notes
- The live database was inspected via `psql -h localhost -p 5432 -U <user> questables` using credentials from `.env.local`; outputs redacted to avoid leaking secrets.
- Future schema adjustments must continue to be authored in `database/schema.sql` per the Questables zero-migration policy and documented in `clearance_and_connect_tasks_documentation.md`.
- Verified the updated `database/schema.sql` by applying it to a fresh database (`questables_dmtoolkit_tmp`) via `psql -f` with no errors beyond idempotent trigger notices.
